<!DOCTYPE html>
<html>
<head>
    <title>PMS Backend Support</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            margin-bottom: 20px;
        }

        .header h1 {
            margin: 0;
            color: #2196F3;
            font-size: 24px;
        }

        .header p {
            margin: 5px 0;
            color: #666;
        }

        .main-content {
            display: flex;
            flex: 1;
            gap: 20px;
            min-height: 0;
        }

        .log-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            background: #1E1E1E;
            border-radius: 8px;
            padding: 10px;
            height: calc(100vh - 250px);
        }

        #log {
            flex: 1;
            color: #00FF00;
            font-family: monospace;
            font-size: 12px;
            margin: 0;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .control-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }

        .status-text {
            font-weight: bold;
            color: #4CAF50;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            opacity: 0.9;
        }

        .start-btn {
            background-color: #4CAF50;
            color: white;
        }

        .stop-btn {
            background-color: #f44336;
            color: white;
        }

        .restart-btn {
            background-color: #FF9800;
            color: white;
        }

        .update-btn {
            background-color: #2196F3;
            color: white;
        }

        .browser-btn {
            background-color: #607D8B;
            color: white;
        }

        .utility-buttons {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: #2c2c2c;
            border-radius: 8px 8px 0 0;
        }

        .utility-btn {
            background-color: #2196F3;
            color: white;
            padding: 8px 16px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .utility-btn:hover {
            background-color: #1976D2;
        }

        .logo-container {
            flex: 1 0 auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-height: 150px;
            max-height: 250px;
        }

        .logo-container img {
            max-width: 100%;
            height: auto;
            width: auto;
            max-height: 120px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .logo-text {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
            font-weight: 500;
        }

        .network-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }

        .network-connected {
            background-color: #E8F5E9;
            color: #2E7D32;
        }

        .network-disconnected {
            background-color: #FFEBEE;
            color: #C62828;
        }

        .update-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
            color: #2196F3;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            width: 70%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            margin: 0;
            color: #2196F3;
            font-size: 20px;
        }

        .modal-body {
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }

        .close:hover {
            color: #f44336;
        }

        /* Developer Card Styles */
        .developer-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .developer-card {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .developer-card h3 {
            margin: 0;
            color: #2196F3;
            font-size: 16px;
        }

        .developer-card p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }

        /* Report Problem Button */
        .report-btn {
            background-color: #E91E63;
            color: white;
            margin-top: 10px;
        }

        /* Report Problem Modal Styles */
        .report-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .form-group label {
            font-weight: bold;
            color: #333;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group select {
            background-color: white;
        }

        .image-preview {
            max-width: 200px;
            max-height: 200px;
            margin-top: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
        }

        .submit-report {
            background-color: #E91E63;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .submit-report:hover {
            background-color: #D81B60;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>J5 Pharmacy Management System - Backend Support</h1>
        <p>Control panel for managing the J5 Pharmacy Management System backend server and system monitoring.</p>
    </div>

    <div class="main-content">
        <div class="log-section">
            <div class="utility-buttons">
                <button id="openLogs" class="utility-btn">
                    <i class="fas fa-folder-open"></i> Open Logs Folder
                </button>
                <button id="checkNetwork" class="utility-btn">
                    <i class="fas fa-network-wired"></i> Check Network
                </button>
                <button id="saveSystemLogs" class="utility-btn">
                    <i class="fas fa-save"></i> Save System Logs
                </button>
            </div>
            <pre id="log"></pre>
        </div>

        <div class="control-section">
            <div class="status-card">
                <div id="serverStatus" class="status-text">Server is stopped</div>
                <div id="networkStatus" class="network-status">Checking network...</div>
                <div id="updateStatus" class="update-status"></div>
            </div>

            <div class="button-group">
                <button id="startServer" class="start-btn">
                    <i class="fas fa-play"></i> Start Server
                </button>
                <button id="stopServer" class="stop-btn">
                    <i class="fas fa-stop"></i> Stop Server
                </button>
                <button id="restartServer" class="restart-btn">
                    <i class="fas fa-sync"></i> Restart Server
                </button>
                <button id="checkUpdate" class="update-btn">
                    <i class="fas fa-download"></i> Check for Updates
                </button>
                <button id="openBrowser" class="browser-btn">
                    <i class="fas fa-external-link-alt"></i> Open Browser
                </button>
                <button id="reportProblem" class="report-btn">
                    <i class="fas fa-bug"></i> Report Problem
                </button>
            </div>

            <div class="logo-container">
                <img src="icons/icon.png" alt="J5 Pharmacy Logo">
                <div class="logo-text">J5 Pharmacy Management System</div>
            </div>
        </div>
    </div>

    <!-- Instructions Modal -->
    <div id="instructionsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Instructions</h2>
            </div>
            <div class="modal-body">
                <h3>Getting Started</h3>
                <ol>
                    <li>Click "Start Server" to initialize the backend server</li>
                    <li>Wait for the server status to show "Server is running"</li>
                    <li>Click "Open Browser" to access the PMS web interface</li>
                </ol>

                <h3>Server Controls</h3>
                <ul>
                    <li><strong>Start Server:</strong> Initializes the backend server</li>
                    <li><strong>Stop Server:</strong> Shuts down the server safely</li>
                    <li><strong>Restart Server:</strong> Stops and restarts the server</li>
                    <li><strong>Check for Updates:</strong> Checks for system updates</li>
                </ul>

                <h3>Troubleshooting</h3>
                <ul>
                    <li>Check the log window for error messages</li>
                    <li>Ensure all required services are running</li>
                    <li>Verify network connectivity using the "Check Network" button</li>
                    <li>In case of errors, use the "Save System Logs" button to generate a log file and contact the development team with the file attached</li>
                    <li>Error logs are automatically generated and saved in the application's data directory when crashes occur</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">About PMS Backend Support</h2>
            </div>
            <div class="modal-body">
                <p>The Backend Support application manages and monitors the core server functionality of the J5 Pharmacy Management System.</p>
                
                <h3>Backend Capabilities</h3>
                <ul>
                    <li><strong>Server Management:</strong> Start, stop, and monitor the backend server</li>
                    <li><strong>Database Operations:</strong> Handles MySQL database connections and queries</li>
                    <li><strong>API Services:</strong> RESTful API endpoints for frontend communication</li>
                    <li><strong>Real-time Updates:</strong> WebSocket integration for live data synchronization</li>
                    <li><strong>Security:</strong> JWT authentication and request validation</li>
                    <li><strong>Error Logging:</strong> Comprehensive error tracking and logging system</li>
                </ul>

                <h3>System Requirements</h3>
                <ul>
                    <li>Node.js Runtime Environment</li>
                    <li>MySQL Database Server</li>
                    <li>Minimum 4GB RAM</li>
                    <li>Windows 8 or higher</li>
                </ul>

                <h3>Version Information</h3>
                <p>Version: 1.0.2</p>
                <p>Â© 2024 J5 Pharmacy. All rights reserved.</p>
                
                <h3>Support</h3>
                <p>For technical support and inquiries, please contact the development team through the Developers section.</p>
            </div>
        </div>
    </div>

    <!-- Developers Modal -->
    <div id="developersModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Zen Garden Team</h2>
            </div>
            <div class="modal-body">
                <div class="developer-cards">
                    <div class="developer-card">
                        <h3>Project Manager</h3>
                        <p>Kevin Llanes</p>
                        <p>kevsllanes@gmail.com</p>
                    </div>
                    <div class="developer-card">
                        <h3>System Analyst</h3>
                        <p>Bea Alyssa Lugtu</p>
                        <p>lugtubealyssa@gmail.com</p>
                    </div>
                    <div class="developer-card">
                        <h3>Backend Developer</h3>
                        <p>Karl Mathew Miranda</p>
                        <p>@gmail.com</p>
                    </div>
                    <div class="developer-card">
                        <h3>Backend Developer</h3>
                        <p>James Ivan Camique</p>
                        <p>@gmail.com</p>
                    </div>
                    <div class="developer-card">
                        <h3>Business Analyst</h3>
                        <p>@gmail.com</p>
                        <p></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Problem Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <div class="modal-header">
                <h2 class="modal-title">Report a Problem</h2>
            </div>
            <div class="modal-body">
                <form id="reportForm" class="report-form">
                    <div class="form-group">
                        <label for="problemCategory">Problem Category</label>
                        <select id="problemCategory" required>
                            <option value="">Select a category</option>
                            <option value="server">Server Issues</option>
                            <option value="database">Database Connection</option>
                            <option value="performance">Performance Issues</option>
                            <option value="ui">User Interface Issues</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="problemTitle">Brief Description</label>
                        <input type="text" id="problemTitle" placeholder="Enter a brief title for the issue" required>
                    </div>
                    <div class="form-group">
                        <label for="problemDescription">Detailed Description</label>
                        <textarea id="problemDescription" placeholder="Please describe what happened and steps to reproduce the issue" required></textarea>
                    </div>
                    <div class="form-group">
                        <label for="imageAttachment">Attach Screenshots (optional)</label>
                        <input type="file" id="imageAttachment" accept="image/*" multiple>
                        <div id="imagePreview" class="image-preview"></div>
                    </div>
                    <button type="submit" class="submit-report">
                        <i class="fas fa-paper-plane"></i> Submit Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const log = document.getElementById('log');
        const serverStatus = document.getElementById('serverStatus');
        const networkStatus = document.getElementById('networkStatus');
        const updateStatus = document.getElementById('updateStatus');
        const stopServerBtn = document.getElementById('stopServer');
        const restartServerBtn = document.getElementById('restartServer');
        const openBrowserBtn = document.getElementById('openBrowser');

        // Initially disable stop, restart, and browser buttons
        stopServerBtn.disabled = true;
        restartServerBtn.disabled = true;
        openBrowserBtn.disabled = true;

        // Add disabled button styles
        const styleSheet = document.styleSheets[1]; // Get the main stylesheet
        styleSheet.insertRule(`
            button:disabled {
                opacity: 0.5;
                cursor: not-allowed;
                filter: grayscale(100%);
            }
        `, styleSheet.cssRules.length);

        function appendLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            log.textContent += `[${timestamp}] ${message}\n`;
            log.scrollTop = log.scrollHeight;
        }

        // Server controls
        document.getElementById('startServer').addEventListener('click', () => {
            appendLog('Starting server...');
            ipcRenderer.send('server:start');
        });

        stopServerBtn.addEventListener('click', () => {
            appendLog('Stopping server...');
            ipcRenderer.send('server:stop');
        });

        restartServerBtn.addEventListener('click', () => {
            appendLog('Restarting server...');
            ipcRenderer.send('server:restart');
        });

        document.getElementById('checkUpdate').addEventListener('click', () => {
            appendLog('Checking for updates...');
            ipcRenderer.send('check:update');
        });

        document.getElementById('openBrowser').addEventListener('click', () => {
            if (!serverRunning) {
                appendLog('Cannot open browser: Server is not running');
                return;
            }
            appendLog('Opening browser...');
            ipcRenderer.send('open:browser');
        });

        document.getElementById('openLogs').addEventListener('click', () => {
            appendLog('Opening logs folder...');
            ipcRenderer.send('open:logs');
        });

        document.getElementById('checkNetwork').addEventListener('click', () => {
            appendLog('Checking network connectivity...');
            ipcRenderer.send('check:network');
            networkStatus.textContent = 'Checking network...';
            networkStatus.className = 'network-status';
        });

        document.getElementById('saveSystemLogs').addEventListener('click', () => {
            appendLog('Saving system logs...');
            ipcRenderer.send('save:systemLogs', log.textContent);
        });

        // IPC handlers
        ipcRenderer.on('server:started', () => {
            serverStatus.textContent = 'Server is running';
            serverStatus.style.color = '#4CAF50';
            appendLog('Server started successfully');
            // Enable stop, restart, and browser buttons
            stopServerBtn.disabled = false;
            restartServerBtn.disabled = false;
            openBrowserBtn.disabled = false;
            serverRunning = true;
        });

        ipcRenderer.on('server:stopped', () => {
            serverStatus.textContent = 'Server is stopped';
            serverStatus.style.color = '#f44336';
            appendLog('Server stopped');
            // Disable stop, restart, and browser buttons
            stopServerBtn.disabled = true;
            restartServerBtn.disabled = true;
            openBrowserBtn.disabled = true;
            serverRunning = false;
        });

        ipcRenderer.on('server:log', (event, message) => {
            appendLog(message);
        });

        ipcRenderer.on('network:status', (event, { connected, latency }) => {
            if (connected) {
                networkStatus.textContent = `Connected to Internet (${latency}ms)`;
                networkStatus.className = 'network-status network-connected';
                appendLog(`Network connection successful (${latency}ms)`);
            } else {
                networkStatus.textContent = 'No Internet Connection';
                networkStatus.className = 'network-status network-disconnected';
                appendLog('Network connection failed');
            }
        });

        ipcRenderer.on('update:status', (event, message) => {
            updateStatus.textContent = message;
            appendLog(message);
        });

        ipcRenderer.on('logs:saved', (event, path) => {
            appendLog(`Logs saved to: ${path}`);
        });

        // Initial log and checks
        appendLog('Application started');
        
        // Check for updates on startup
        setTimeout(() => {
            appendLog('Performing initial update check...');
            ipcRenderer.send('check:update');
        }, 2000);

        // Automatic network check on startup
        window.addEventListener('load', () => {
            setTimeout(() => {
                ipcRenderer.send('check:network');
            }, 1000);
        });

        // Add these after the existing script content
        const modals = {
            instructions: document.getElementById('instructionsModal'),
            about: document.getElementById('aboutModal'),
            developers: document.getElementById('developersModal')
        };

        // IPC handlers for showing modals
        ipcRenderer.on('show:instructions', () => {
            appendLog('Opening Instructions...');
            modals.instructions.style.display = 'block';
        });

        ipcRenderer.on('show:about', () => {
            appendLog('Opening About...');
            modals.about.style.display = 'block';
        });

        ipcRenderer.on('show:developers', () => {
            appendLog('Opening Developers...');
            modals.developers.style.display = 'block';
        });

        // Close button handling for all modals
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.onclick = function() {
                this.closest('.modal').style.display = 'none';
                appendLog('Closed modal');
            }
        });

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
                appendLog('Closed modal');
            }
        }

        // Report Problem functionality
        const reportModal = document.getElementById('reportModal');
        const reportBtn = document.getElementById('reportProblem');
        const reportForm = document.getElementById('reportForm');
        const imageAttachment = document.getElementById('imageAttachment');
        const imagePreview = document.getElementById('imagePreview');

        reportBtn.addEventListener('click', () => {
            appendLog('Opening Report Problem form...');
            reportModal.style.display = 'block';
        });

        imageAttachment.addEventListener('change', (e) => {
            imagePreview.innerHTML = '';
            imagePreview.style.display = 'block';
            
            [...e.target.files].forEach(file => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.maxWidth = '200px';
                    img.style.marginRight = '10px';
                    img.style.marginBottom = '10px';
                    imagePreview.appendChild(img);
                };
                reader.readAsDataURL(file);
            });
        });

        reportForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            appendLog('Submitting problem report...');

            // Disable submit button and show loading state
            const submitBtn = reportForm.querySelector('.submit-report');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';

            try {
                // Process images first
                const imagePromises = [...imageAttachment.files].map(file => {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            resolve({
                                name: file.name,
                                data: e.target.result
                            });
                        };
                        reader.readAsDataURL(file);
                    });
                });

                const processedImages = await Promise.all(imagePromises);

                const formData = {
                    category: document.getElementById('problemCategory').value,
                    title: document.getElementById('problemTitle').value,
                    description: document.getElementById('problemDescription').value,
                    systemLogs: log.textContent,
                    images: processedImages
                };

                ipcRenderer.send('submit:report', formData);
            } catch (error) {
                appendLog(`Error processing form data: ${error.message}`);
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Report';
            }
        });

        // Add handlers for report submission response
        ipcRenderer.on('report:sent', (event, message) => {
            appendLog('Problem report sent successfully');
            const submitBtn = reportForm.querySelector('.submit-report');
            submitBtn.innerHTML = '<i class="fas fa-check"></i> Sent!';
            setTimeout(() => {
                reportModal.style.display = 'none';
                reportForm.reset();
                imagePreview.style.display = 'none';
                imagePreview.innerHTML = '';
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Report';
            }, 2000);
        });

        ipcRenderer.on('report:error', (event, error) => {
            appendLog(`Error sending report: ${error}`);
            const submitBtn = reportForm.querySelector('.submit-report');
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Failed to Send';
            submitBtn.style.backgroundColor = '#f44336';
            
            // Show error message to user
            const errorDiv = document.createElement('div');
            errorDiv.style.color = '#f44336';
            errorDiv.style.marginTop = '10px';
            errorDiv.style.fontSize = '14px';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i> ${error}`;
            
            const existingError = reportForm.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            errorDiv.className = 'error-message';
            reportForm.appendChild(errorDiv);

            // Reset button after 3 seconds
            setTimeout(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Report';
                submitBtn.style.backgroundColor = '#E91E63';
            }, 3000);
        });
    </script>
</body>
</html> 